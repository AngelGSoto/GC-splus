#+TITLE: Photometric Analysis of Globular Clusters in NGC 5128 (Centaurus A)
#+AUTHOR: Luis A. Gutiérrez Soto
#+DATE: 15/09/2025
#+DESCRIPTION: Complete pipeline for photometric analysis of globular clusters in Centaurus A using SPLUS data
#+STARTUP: showall

* Introduction
** NGC 5128 (Centaurus A)
Centaurus A (also known as NGC 5128 or Caldwell 77) is a galaxy in the constellation of Centaurus.
It was discovered in 1826 by Scottish astronomer James Dunlop from his home in Parramatta,
in New South Wales, Australia. 

*** Key Properties
- Hubble type: Lenticular galaxy or giant elliptical galaxy (debated in literature)
- Distance: 11-13 million light-years (uncertain)
- Significance:
  - Closest radio galaxy to Earth
  - Closest BL Lac object
  - Fifth-brightest galaxy in the sky
- Visibility: Only visible from the southern hemisphere and low northern latitudes

** Project Objective
Perform aperture photometry of globular clusters in NGC 5128 using data from the SPLUS (Southern Photometric Local Universe Survey).

* Project Structure
** Main Directories
.
├── anac_data/                 # SPLUS data (by field)
├── Programs/             # Python scripts
├── programss/            # Python scripts to do synthetic photometry
├── Results/             # Photometry results
└── Documentation/       # Documentation (this file)

** Processed SPLUS Fields
| Field  | RA       | DEC      | Notes |
|--------+----------+----------+-------|
| CenA01 | 200.1234 | -47.2345 |       |
| ...    | ...      | ...      |       |
| CenA24 | 200.5678 | -46.7890 |       |

* Methodology
** Pipeline Summary
1. Estimate instrumetal photometry for referece stars
2. Extraction of Gaia XP spectra for reference stars
3. Generation of synthetic photometry from XP spectra
4. Zero-point calculation for each field
5. Aperture photometry of globular clusters

** Step 1: Extraction of Gaia XP Spectra
*** Objective
Identify stars in each SPLUS field and estimate the intrumentl
magnitude using the python pagcage photutils obtain their
Gaia DR3 XP spectra for calibration.

*** Script Used
#+BEGIN_SRC sh
python ../Programs/extract_splus_gaia_xp_final.py
#+END_SRC

*** Inputs
- SPLUS images for each field
- Gaia DR3 catalog (automatically queried)

*** Outputs
- CenAXX_gaia_xp_matches.csv → Catalog of matched stars
- gaia_spectra_CenAXX/ → Directory with spectra in ASCII format

*** Notes
- ~100 stars per field used as references
- Script performs cross-match between SPLUS detections and Gaia DR3
- Downloads XP spectra for matched stars

** Step 2: Synthetic Photometry
*** Objective
Calculate synthetic SPLUS magnitudes from Gaia XP spectra.

*** Execution Command
#+BEGIN_SRC sh
for D in ./gaia_spectra_CenA*; do 
    if [ -d "$D" ]; then 
        cd "$D"; 
        for f in *.dat; do 
            python ../../programs/symphotometry.py ${f%.dat} --filters SPLUS21 --name Ref --savefig --debug; 
        done; 
        cd ..; 
    fi; 
done
#+END_SRC

*** Parameters
- --filters SPLUS21 → SPLUS filters (12 bands)
- --savefig → Save diagnostic plots
- --debug → Verbose mode for debugging

*** Outputs
- Synthetic magnitudes for all SPLUS filters
- Diagnostic plots (if --savefig used)

** Step 3: Zero-point Calculation
*** Objective
Calculate photometric zero-points by comparing instrumental and synthetic magnitudes.

*** Individual Processing
#+BEGIN_SRC sh
python ../Programs/calculate_zero_points.py CenA01_gaia_xp_matches.csv --json-dir . --plot
#+END_SRC

*** Expected Output
#+BEGIN_EXAMPLE
Processing field CenA01 with 396 stars
mag_F378: 100 stars, Median ZP = 19.649 ± 0.049 (MAD)
mag_F395: 100 stars, Median ZP = 19.683 ± 0.056 (MAD)
...
Results saved to CenA01_zero_points.csv
Plot saved as CenA01_zero_points.png
#+END_EXAMPLE

*** Batch Processing (All Fields)
#+BEGIN_SRC sh
python ../Programs/ZeroPoints_calculations.py
#+END_SRC

*** Output Files
- all_fields_zero_points_detailed.csv → Detailed results
- average_zero_points_detailed.csv → Average zero-points with uncertainties
- all_fields_zero_points_splus_format.csv → Zero-points in SPLUS format
- average_zero_points_splus_format.csv → Average zero-points in SPLUS format

*** Statistical Summary
#+BEGIN_EXAMPLE
=== SPLUS FORMAT SUMMARY ===
Processed 24 fields
F378: 19.534433 ± 0.124996
F395: 19.626046 ± 0.121728
...
#+END_EXAMPLE

** Step 4: Globular Cluster Photometry
*** Objective
Perform aperture photometry of globular clusters using the calculated zero-points.

*** Main Script
#+BEGIN_SRC sh
python Splus_photometry_final.py
#+END_SRC

*** Main Inputs
- TAP_1_J_MNRAS_3444_gc.csv → Globular cluster catalog
- all_fields_zero_points_splus_format.csv → Zero-points for all fields
- SPLUS images for each field and filter

*** Photometry Parameters
- Apertures: 3, 4, 5, 6 arcsec (diameter)
- Background annulus: 6-9 arcsec
- Minimum SNR: 3

*** Outputs
- CenAXX_gc_photometry.csv → Individual field results
- all_fields_gc_photometry_merged.csv → Final combined catalog

*** Background correction
Correcting the variable background of the galaxy is crucial for obtaining
accurate photometry of the globular clusters in Centaurus A. This step was
suggested by Ana after reviewing the initial results.
We implement background subtraction using Photutils' Background2D, which
models the variable background by dividing the image into boxes and fitting
a background model in each box. This approach is more robust than a simple
unsharp mask for this application.

The script based on the last one is:


#+BEGIN_SRC sh
python Splus_photometry_final_bg_mask.py
#+END_SRC

**** Key parameters:

    box_size = 50 pixels :: Size of the box for background estimation. This should be
    larger than typical globular clusters but smaller than the background structures
    of the galaxy.

    filter_size = 3 :: Size of the filter to apply to the background map.

    sigma_clip = SigmaClip(sigma=3.0) :: Sigma clipping parameters for excluding sources.

    snr_threshold = 2 :: Signal-to-noise ratio for source detection in masking.

    npixels = 5 :: Minimum number of connected pixels for source detection.

    dilate_size = 11 :: Size of dilation kernel for expanding source masks.

**** Implementation:
The background subtraction is performed for each filter image before doing
aperture photometry. We create a mask to exclude bright objects (stars and
clusters) when estimating the background.

**** Verification:
We generate verification images for one
filter per field (to avoid too many files) showing:

....

The terminal print (just runing for one field):

#+BEGIN_SRC sh
python ../Programs/Splus_photometry_final_bg_mask.py 
Loaded catalog with 3210 sources
Processing field CenA01
Found 181 sources in field CenA01
  Processing filter F378
Background subtracted with box_size=50
  Processing filter F395
Background subtracted with box_size=50
  Processing filter F410
Background subtracted with box_size=50
  Processing filter F430
Background subtracted with box_size=50
  Processing filter F515
Background subtracted with box_size=50
  Processing filter F660
Saved background debug image for CenA01 F660
Background subtracted with box_size=50
Saved debug aperture image for CenA01 F660
  Processing filter F861
Background subtracted with box_size=50
Saved results for CenA01 to CenA01_gc_photometry.csv
Final merged results saved to all_fields_gc_photometry_merged.csv
Total sources in original catalog: 3210
Total sources with measurements: 181
F378_3: 3169 valid, Mean SNR: 0.4, Mean Mag: 25.51
F378_4: 3159 valid, Mean SNR: 0.4, Mean Mag: 25.28
F378_5: 3162 valid, Mean SNR: 0.4, Mean Mag: 25.29
F378_6: 3157 valid, Mean SNR: 0.5, Mean Mag: 25.26
F395_3: 3166 valid, Mean SNR: 0.4, Mean Mag: 23.70
F395_4: 3155 valid, Mean SNR: 0.5, Mean Mag: 23.45
F395_5: 3145 valid, Mean SNR: 0.5, Mean Mag: 23.31
F395_6: 3141 valid, Mean SNR: 0.6, Mean Mag: 23.37
F410_3: 3171 valid, Mean SNR: 0.8, Mean Mag: 23.77
F410_4: 3166 valid, Mean SNR: 0.9, Mean Mag: 23.71
F410_5: 3158 valid, Mean SNR: 0.9, Mean Mag: 23.70
F410_6: 3150 valid, Mean SNR: 1.0, Mean Mag: 23.75
F430_3: 3178 valid, Mean SNR: 0.9, Mean Mag: 23.17
F430_4: 3168 valid, Mean SNR: 1.0, Mean Mag: 23.08
F430_5: 3160 valid, Mean SNR: 1.0, Mean Mag: 22.98
F430_6: 3151 valid, Mean SNR: 1.1, Mean Mag: 23.01
F515_3: 3182 valid, Mean SNR: 1.3, Mean Mag: 23.17
F515_4: 3172 valid, Mean SNR: 1.4, Mean Mag: 23.10
F515_5: 3165 valid, Mean SNR: 1.5, Mean Mag: 23.15
F515_6: 3158 valid, Mean SNR: 1.5, Mean Mag: 23.33
F660_3: 3180 valid, Mean SNR: 1.7, Mean Mag: 21.62
F660_4: 3175 valid, Mean SNR: 1.8, Mean Mag: 21.55
F660_5: 3165 valid, Mean SNR: 2.0, Mean Mag: 21.56
F660_6: 3159 valid, Mean SNR: 2.1, Mean Mag: 21.53
F861_3: 3183 valid, Mean SNR: 2.1, Mean Mag: 23.37
F861_4: 3180 valid, Mean SNR: 2.2, Mean Mag: 23.29
F861_5: 3172 valid, Mean SNR: 2.3, Mean Mag: 23.42
F861_6: 3164 valid, Mean SNR: 2.5, Mean Mag: 23.48
#+END_SRC

*** Final Catalog Structure
| Column         | Description                                 | Special Values        |
|-----------------+---------------------------------------------+---------------------------|
| [Original columns] | From TAP_1_J_MNRAS_3444_gc catalog          |                           |
| FLUX_FXXX_Y      | Flux in filter FXXX with aperture Y arcsec  | 0.0 = Not measured        |
| FLUXERR_FXXX_Y   | Flux error                                  | 99.0 = Measurement error  |
| MAG_FXXX_Y       | Magnitude                                   | 99.0 = Source not detectable |
| MAGERR_FXXX_Y    | Magnitude error                             | 99.0 = Measurement error  |
| SNR_FXXX_Y       | Signal-to-noise ratio                       | 0.0 = Not measured        |
| FIELD            | SPLUS field where source was measured       | NaN = Source not in field |

* Execution Instructions
** Initial Setup
1. Ensure correct directory structure
2. Verify all SPLUS fields are available
3. Confirm location of globular cluster catalog

** Execution Order
1. Extract Gaia XP spectra → Step 1
2. Generate synthetic photometry → Step 2
3. Calculate zero-points → Step 3
4. Run cluster photometry → Step 4

** Complete Reprocessing Command
#+BEGIN_SRC sh
# Step 1: Extract XP spectra
python ../Programs/extract_splus_gaia_xp_final.py

# Step 2: Synthetic photometry (run in spectra directory)
for D in ./gaia_spectra_CenA*; do 
    if [ -d "$D" ]; then 
        cd "$D"; 
        for f in *.dat; do 
            python ../../programs/symphotometry.py ${f%.dat} --filters SPLUS21 --name Ref --savefig; 
        done; 
        cd ..; 
    fi; 
done

# Step 3: Zero-point calculation
python ../Programs/ZeroPoints_calculations.py

# Step 4: Cluster photometry
python Splus_photometry_final.py
#+END_SRC

* Troubleshooting
** Common Issues
*** SPLUS Images Not Found
- Verify directory structure
- Ensure images follow correct naming convention

*** No Zero-points for a Field
- Verify field is in all_fields_zero_points_splus_format.csv
- Check zero-point calculation for that specific field

*** Sources Near Edge
- Script automatically flags with 99.0 for edge sources
- Consider using smaller aperture for these sources

** Result Interpretation
- Magnitude values of 99.0: Source detected but not properly measured
- NaN values: Source not in field
- SNR < 3: Measurements considered unreliable

* Results and Products
** Generated Catalogs
- all_fields_gc_photometry_merged.csv → Main catalog with all measurements
- CenAXX_gc_photometry.csv → Individual field results

** Output Formats
- CSV with columns organized by filter and aperture
- Special values: 99.0 for failed measurements, NaN for out-of-field sources

** Quality Analysis
- Script includes statistical summary of data quality
- Reports number of valid measurements per filter and aperture
- Provides average SNR and average magnitude per filter

* Technical Notes
** System Requirements
- Python 3.7+
- Memory: ≥8GB RAM recommended for processing all fields
- Storage: ~50GB for SPLUS images + results

** Python Dependencies
- astropy, numpy, pandas, photutils, tqdm, matplotlib

** Estimated Execution Time
- Complete run: 6-12 hours (hardware dependent)
- Per field: 15-30 minutes

* Science

* Contact and References
- Author: Luis A. Gutiérrez Soto
- Email: gsoto.angel@gmail.com
- Catalog reference: TAP_1_J_MNRAS_3444_gc.csv (Taylor et al. 2017, MNRAS, 3444)
- SPLUS Survey: Mendes de Oliveira et al. (2019)

#+BEGIN_CENTER
* Documentation last updated: 18/09/2025 *
#+END_CENTER
